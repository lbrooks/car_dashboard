<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=0.5, user-scalable=no">

    <link type="text/css" rel="stylesheet" media="all" href="/rickshaw/rickshaw.min.css"/>
    <script src="/jquery/dist/jquery.min.js" type="text/javascript"></script>
    <script src="/d3/d3.min.js" type="text/javascript"></script>
    <script src="/rickshaw/rickshaw.min.js" type="text/javascript"></script>
    <script src="/moment/min/moment.min.js" type="text/javascript"></script>
<style>
body * { vertical-align: top; }

.rickshaw_graph .detail .x_label {
  display: none;
}

#js-estimateTable, #js-estimateTable * {
  border:1px solid black;
  border-collapse: collapse;
  text-align:center;
}
#js-estimateTable tbody, #js-estimateTable tbody {
  border-color:#fff;
  color:#fff;
}
#js-estimateTable tbody *, #js-estimateTable tbody * {
  border-color:#fff;
}

#trip_graph, #mpg_graph {
  max-width:47%;
}

@media only screen and (max-device-width: 480px) {
  #trip_graph, #mpg_graph {
    max-width: none;
  }
}

</style>
  </head>
  <body>
    <table id="js-estimateTable" style="width:100%; border:1px solid black;">
      <thead>
        <tr>
          <th rowspan="2" style="vertical-align: bottom;">Car</th>
          <th rowspan="2" style="vertical-align: bottom;">Next Milage Marker</th>
          <th colspan="3">Estimated Month Until Next 10k (by past x months)</th>
        </tr>
        <tr>
          <th>2 months</th>
          <th>4 months</th>
          <th>6 months</th>
        </tr>
      </thead>
      <tbody id="js-tableData">
      </tbody>
    </table>
    <div id="trip_graph" style="display:inline-block; margin: 30px 1% 30px 1%; width:100%;"></div>
    <div id="mpg_graph" style="display:inline-block; margin: 30px 1% 30px 1%; width:100%;"></div>
    <script>
      var palette = d3.scale.category10();

      $.ajax({
        url:"/json/car/projection",
      }).done(function(data){
        console.log(data);
        var newRows = d3.select('#js-tableData').selectAll('tr').data(data.result).enter().append("tr").style("background-color", function(d,i){return palette(i); });
        newRows.append("td").text(function(d){ return d.name; });
        newRows.append("td").text(function(d){ return d3.format(",s")(d.nextMarker*10000); });
        newRows.append("td").text(function(d){ return d.est2 == 'Never' ?d.est2 :moment.utc(new Date(d.est2*1000)).format("MMMM YYYY"); });
        newRows.append("td").text(function(d){ return d.est4 == 'Never' ?d.est4 :moment.utc(new Date(d.est4*1000)).format("MMMM YYYY"); });
        newRows.append("td").text(function(d){ return d.est6 == 'Never' ?d.est6 :moment.utc(new Date(d.est6*1000)).format("MMMM YYYY"); });
      });

      $.ajax({
        url:"/json/car/monthly",
      }).done(function(data){
        var tripSeries = [];
        var mpgSeries = [];
        var all_trips = [];
        var all_mpgs = [];
        data.result.forEach(function(car_e,car_i,car_a){
          var tripData = { color: palette(car_i), name: car_e.name, data:[] };
          var mpgData = { color: palette(car_i), name: car_e.name, data:[] };

          car_e.recorded.forEach(function(rec_e,rec_i,rec_a){
            tripData.data.push({x:rec_e.month, y:rec_e.trip});
            mpgData.data.push({x:rec_e.month, y:rec_e.mpg});
            all_trips.push(rec_e.trip);
            all_mpgs.push(rec_e.mpg);
          });

          tripSeries.push(tripData);
          mpgSeries.push(mpgData);
        });
        mpgSeries.forEach(function(car){
          car.scale = d3.scale.linear().domain(d3.extent(all_mpgs)).nice();
        });
        tripSeries.forEach(function(car){
          car.scale = d3.scale.linear().domain(d3.extent(all_trips)).nice();
        });

        var trip_graph = new Rickshaw.Graph({
          element: $("#trip_graph")[0],
          width: $("#trip_graph").width()-30,
          height: $("#trip_graph").width()*.55,
          renderer:'line',
          series: tripSeries
        });
        new Rickshaw.Graph.Axis.Time( { graph: trip_graph } );
        new Rickshaw.Graph.Axis.Y.Scaled( {
          graph: trip_graph,
          tickFormat: function(d){ return d3.format(",")(d) + ' miles'; },
          scale: d3.scale.linear().domain(d3.extent(all_trips)).nice(),
          orientation: 'right'
        } );
        new Rickshaw.Graph.HoverDetail( {
            graph: trip_graph,
            formatter: function(series, x, y){
              var content = series.name
                  +'<span style="float:right;">'+d3.format(',')(parseInt(y))+' miles</span>'
                  +'<div style="width:150px">'+moment.utc(new Date(x*1000)).format('MMMM YYYY')+'</div>';
              return content;
            }
        });
        trip_graph.render();

        var mpg_graph = new Rickshaw.Graph({
          element: $("#mpg_graph")[0],
          width: $("#mpg_graph").width()-30,
          height: $("#mpg_graph").width()*.55,
          renderer:'line',
          series: mpgSeries
        });
        new Rickshaw.Graph.Axis.Time( { graph: mpg_graph } );
        new Rickshaw.Graph.Axis.Y.Scaled( {
          graph: mpg_graph,
          tickFormat: function(d){ return d3.format(",")(d) + ' mpg'; },
          scale: d3.scale.linear().domain(d3.extent(all_mpgs)).nice(),
          orientation: 'right'
        } );
        $("#mpg_graph .y_axis svg").attr("style", "height:"+($("#mpg_graph").width()*.5)+"px;");
        new Rickshaw.Graph.HoverDetail( {
            graph: mpg_graph,
            formatter: function(series, x, y){
              var content = series.name
                  +'<span style="float:right;">'+d3.format(',')(parseInt(y))+' mpg</span>'
                  +'<div style="width:150px">'+moment.utc(new Date(x*1000)).format('MMMM YYYY')+'</div>';
              return content;
            }
        });
        mpg_graph.render();
      });
    </script>
  </body>
</html>  
